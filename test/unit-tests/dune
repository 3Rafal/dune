(executable
 (name expect_test)
 (modules expect_test)
 (link_flags (-linkall))
 (modes byte)
 (libraries stdune wp_dune unix dune compiler-libs.toplevel test_common dag))

(ocamllex expect_test)

(executable
 (name sexp_tests)
 (modules sexp_tests)
 (libraries stdune dune_lang))

(alias
 (name runtest)
 (action (run ./sexp_tests.exe)))

(alias
 (name runtest)
 (deps (:t expect_test_tests.mlt))
 (action (chdir %{project_root}
          (progn
           (run %{exe:expect_test.exe} %{t})
           (diff? %{t} %{t}.corrected)))))

(alias
 (name runtest)
 (deps (:t import_dot_map.mlt)
  (glob_files %{project_root}/src/.dune.objs/byte/*.cmi)
  (glob_files %{project_root}/src/stdune/.stdune.objs/byte/*.cmi))
 (action (chdir %{project_root}
          (progn
           (run %{exe:expect_test.exe} %{t})
           (diff? %{t} %{t}.corrected)))))

(alias
 (name runtestdag)
 (deps (:t dag.mlt)
  (glob_files %{project_root}/src/stdune/.stdune.objs/byte/*.cmi)
  (glob_files %{project_root}/src/dag/.dag.objs/byte/*.cmi))
 (action (chdir %{project_root}
          (progn
           (run %{exe:expect_test.exe} %{t})
           (diff? %{t} %{t}.corrected)))))

(alias
 (name runtest)
 (deps (alias runtestdag)))

(alias
 (name runtestscheme)
 (deps (:t scheme.mlt)
  (glob_files %{project_root}/src/.dune.objs/byte/*.cmi)
  (glob_files %{project_root}/src/stdune/.stdune.objs/byte/*.cmi)
  (glob_files %{project_root}/src/memo/.memo.objs/byte/*.cmi)
  (glob_files %{project_root}/src/fiber/.fiber.objs/byte/*.cmi))
 (action (chdir %{project_root}
          (progn
           (run %{exe:expect_test.exe} %{t})
           (diff? %{t} %{t}.corrected))))
)
(alias
 (name runtest)
 (deps (alias runtestscheme)))
