(* -*- tuareg -*- *)

open Stdune

open Dune_memory.CSexp

let roundtrip x =
  let str = to_string_canonical x in
  let exp = parse_canonical str in
  assert (exp = x) ;
  str

[%%expect{|
val roundtrip : t -> string = <fun>
|}]

roundtrip (Sexp.List []);;
roundtrip (Sexp.List [Sexp.Atom "Hello"; Sexp.Atom "World!"]);;
roundtrip
  (Sexp.List
     [ Sexp.List
         [Sexp.Atom "metadata"; Sexp.List [Sexp.Atom "foo"; Sexp.Atom "bar"]]
     ; Sexp.List
         [ Sexp.Atom "produced-files"
         ; Sexp.List
             [ Sexp.List
                 [ Sexp.Atom "/tmp/coin"
                 ; Sexp.Atom
                     "/tmp/dune-memory/v2/files/b2/b295e63b0b8e8fae971d9c493be0d261.1"
                 ] ] ] ]);;

[%%expect{|
- : string = "()"
- : string = "(5:Hello6:World!)"
- : string =
"((8:metadata(3:foo3:bar))(14:produced-files((9:/tmp/coin63:/tmp/dune-memory/v2/files/b2/b295e63b0b8e8fae971d9c493be0d261.1))))"
|}]
